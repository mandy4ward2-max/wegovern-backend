generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                 Int         @id @default(autoincrement())
  name               String
  code               String      @unique
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  majorityVoteNumber Int         @default(1)
  ownerUserId        Int?
  Issue              Issue[]
  motions            Motion[]
  approvals          Approval[]
  meetings           Meeting[]
  owner              User?       @relation("OrgOwner", fields: [ownerUserId], references: [id])
  users              User[]
}

model User {
  id                             Int            @id @default(autoincrement())
  firstName                      String
  lastName                       String
  email                          String         @unique
  password                       String
  role                           String
  orgId                          Int
  createdAt                      DateTime       @default(now())
  updatedAt                      DateTime       @updatedAt
  Attachment                     Attachment[]
  comments                       Comment[]
  Issue_Issue_assignedToIdToUser Issue[]        @relation("Issue_assignedToIdToUser")
  Issue_Issue_createdByIdToUser  Issue[]        @relation("Issue_createdByIdToUser")
  Issue_Issue_closedByIdToUser   Issue[]        @relation("Issue_closedByIdToUser")
  Motion                         Motion[]
  orgsOwned                      Organization[] @relation("OrgOwner")
  tasks                          Task[]
  org                            Organization   @relation(fields: [orgId], references: [id])
  votes                          Vote[]
  taggedInComments               Comment[]      @relation("CommentTags")
  approvalsSubmitted             Approval[]     @relation("ApprovalSubmittedBy")
  approvalsProcessed             Approval[]     @relation("ApprovalApprovedBy")
  meetingsCreated                Meeting[]      @relation("MeetingCreatedBy")
  meetingInvites                 MeetingInvitee[] @relation("MeetingInvitees")
  agendaAttachmentsUploaded      AgendaAttachment[] @relation("AgendaAttachmentUploadedBy")
}

model Motion {
  id          Int          @id @default(autoincrement())
  motion      String
  userId      Int
  summary     String?
  discussion  String?
  status      String       @default("unapproved") // "unapproved", "pending", "passed", "defeated"
  dateVoted   DateTime?
  issueId     Int?
  orgId       Int
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  attachments Attachment[]
  comments    Comment[]
  Issue       Issue?       @relation(fields: [issueId], references: [id])
  org         Organization @relation(fields: [orgId], references: [id])
  User        User         @relation(fields: [userId], references: [id])
  tasks       Task[]
  votes       Vote[]
  agendaItems AgendaItem[]
}

model Task {
  id              Int        @id @default(autoincrement())
  action          String
  userId          Int
  due             DateTime?
  motionId        Int?
  issueId         Int?
  status          TaskStatus @default(UNAPPROVED)
  completed       Boolean    @default(false)
  dateCompleted   DateTime?
  completeComment String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  Issue           Issue?     @relation(fields: [issueId], references: [id])
  motion          Motion?    @relation(fields: [motionId], references: [id])
  user            User       @relation(fields: [userId], references: [id])
  comments        Comment[]
}

model Comment {
  id          Int       @id @default(autoincrement())
  motionId    Int?
  issueId     Int?
  taskId      Int?
  userId      Int
  text        String
  parentId    Int?
  isDeleted   Boolean   @default(false)
  editedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  motion      Motion?   @relation(fields: [motionId], references: [id])
  issue       Issue?    @relation(fields: [issueId], references: [id])
  task        Task?     @relation(fields: [taskId], references: [id])
  parent      Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies     Comment[] @relation("CommentReplies")
  user        User      @relation(fields: [userId], references: [id])
  taggedUsers User[]    @relation("CommentTags")
}

model Attachment {
  id        Int      @id @default(autoincrement())
  motionId  Int
  userId    Int?
  desc      String?
  filename  String
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  motion    Motion   @relation(fields: [motionId], references: [id])
  User      User?    @relation(fields: [userId], references: [id])
}

model Vote {
  id        Int      @id @default(autoincrement())
  motionId  Int
  userId    Int
  voteType  String
  createdAt DateTime @default(now())
  motion    Motion   @relation(fields: [motionId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model Issue {
  id                            Int          @id @default(autoincrement())
  title                         String
  description                   String?
  status                        String       @default("OPEN")
  priority                      String       @default("MEDIUM")
  orgId                         Int
  createdById                   Int
  assignedToId                  Int?
  closedById                    Int?
  closedAt                      DateTime?
  resolution                    String?
  createdAt                     DateTime     @default(now())
  updatedAt                     DateTime
  User_Issue_assignedToIdToUser User?        @relation("Issue_assignedToIdToUser", fields: [assignedToId], references: [id])
  User_Issue_createdByIdToUser  User         @relation("Issue_createdByIdToUser", fields: [createdById], references: [id])
  User_Issue_closedByIdToUser   User?        @relation("Issue_closedByIdToUser", fields: [closedById], references: [id])
  Organization                  Organization @relation(fields: [orgId], references: [id])
  Motion                        Motion[]
  Task                          Task[]
  comments                      Comment[]
}

model Meeting {
  id              Int           @id @default(autoincrement())
  name            String
  description     String?
  startDateTime   DateTime      // Combined start date and time
  endDateTime     DateTime      // Combined end date and time
  orgId           Int
  createdById     Int
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  org             Organization  @relation(fields: [orgId], references: [id])
  createdBy       User          @relation("MeetingCreatedBy", fields: [createdById], references: [id])
  agendaItems     AgendaItem[]
  invitees        MeetingInvitee[]
}

model MeetingInvitee {
  id          Int      @id @default(autoincrement())
  meetingId   Int
  userId      Int
  createdAt   DateTime @default(now())
  meeting     Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  user        User     @relation("MeetingInvitees", fields: [userId], references: [id])
  
  @@unique([meetingId, userId]) // Ensure each user can only be invited once per meeting
}

model AgendaItem {
  id              Int           @id @default(autoincrement())
  meetingId       Int
  type            String        // "section", "infoItem", "motionItem", "newMotion"
  title           String        // For sections and new motions
  agendaItem      String?       // For info items and submitted motions
  description     String?       // For new motions
  motionId        Int?          // Optional link to a motion (for motionItem type)
  parentSectionId Int?          // Link to parent section for items under sections
  sortOrder       Int           @default(0)
  number          String?       // The display number (e.g., "1.1", "2.3", etc.)
  isSubSection    Boolean       @default(false) // For sub-sections
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  meeting         Meeting       @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  motion          Motion?       @relation(fields: [motionId], references: [id])
  attachments     AgendaAttachment[]
}

model AgendaAttachment {
  id              Int           @id @default(autoincrement())
  agendaItemId    Int
  filename        String
  originalName    String
  url             String
  mimeType        String?
  size            Int?
  uploadedById    Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  agendaItem      AgendaItem    @relation(fields: [agendaItemId], references: [id], onDelete: Cascade)
  uploadedBy      User?         @relation("AgendaAttachmentUploadedBy", fields: [uploadedById], references: [id])
}

model Approval {
  id              Int      @id @default(autoincrement())
  type            String   // "user_registration", "motion_approval", "task_approval", etc.
  status          String   @default("pending") // "pending", "approved", "rejected"
  submittedById   Int
  approvedById    Int?
  dateSubmitted   DateTime @default(now())
  dateProcessed   DateTime?
  description     String?
  relatedId       Int?     // ID of the related record (user, motion, task, etc.)
  orgId           Int
  metadata        String?  // JSON string for additional data
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  submittedBy     User     @relation("ApprovalSubmittedBy", fields: [submittedById], references: [id])
  approvedBy      User?    @relation("ApprovalApprovedBy", fields: [approvedById], references: [id])
  org             Organization @relation(fields: [orgId], references: [id])
}

enum TaskStatus {
  UNAPPROVED
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}
